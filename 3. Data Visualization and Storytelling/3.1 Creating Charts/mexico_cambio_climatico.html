<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Temperatura Máxima Anual por Estado en México (1985–2025)</title>

<!-- Bootstrap -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

<!-- D3 -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v3.min.js"></script>

<style>
  body { background: #ffffff; }

  #map svg { width: 100%; height: 600px; }
  .state { stroke: #fff; stroke-width: 0.7px; }

  #yearLabel { font-size: 24px; font-weight: bold; }

  /* Leyenda extendida */
  .legendContainer {
    width: 900px;
    margin: auto;
  }
  .legendBar {
    height: 22px;
    border: 1px solid #ccc;
    margin-bottom: 4px;
    background: linear-gradient(to right,
      #08306b,
      #2171b5,
      #6baed6,
      #c7e9b4,
      #ffffb2,
      #fed976,
      #fd8d3c,
      #f03b20,
      #bd0026
    );
  }
  .legendTicks {
    display: flex;
    justify-content: space-between;
    font-size: 12px;
  }

  /* Heatmap */
  #heatmap svg { width: 100%; height: 650px; }
  .cell { stroke: #f0f0f0; stroke-width: 0.35px; }

  /* Tooltip */
  .tooltip {
    position: absolute;
    pointer-events: none;
    background: rgba(0,0,0,0.75);
    color: white;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
  }

  .btn-decades {
    font-size: 12px;
    padding: 2px 6px;
  }
</style>
</head>

<body class="container py-4">

<h1 class="text-center mb-4">Temperatura Máxima Anual por Estado en México</h1>

<!-- Storytelling -->
<div class="card shadow p-4 mb-4">
  <h4>México Frente a su Nueva Realidad Climática</h4>
  <p>
    Esta visualización muestra la evolución de la <strong>temperatura máxima anual</strong> en los estados de México
    entre 1985 y 2025. Las máximas son un indicador sensible del calentamiento global, ya que afectan directamente
    la salud, la agricultura y la demanda energética.
  </p>
  <p>
    La escala de colores se extiende desde tonos azules (temperaturas relativamente frías) hasta rojos (muy cálidas).
    Al observar el mapa y el mapa de calor, notarás que México rara vez se acerca a los tonos fríos, reforzando la
    narrativa de que el país se mantiene en rangos cálidos y que las últimas décadas tienden a ser aún más cálidas.
  </p>
</div>

<!-- Controles -->
<div class="d-flex justify-content-center align-items-center mb-2">
  <button id="prevBtn" class="btn btn-primary mx-2">← Año anterior</button>
  <input type="range" id="yearSlider" class="form-range w-50">
  <button id="nextBtn" class="btn btn-primary mx-2">Año siguiente →</button>
</div>

<div class="text-center mb-2">
  <span id="yearLabel">Año: —</span>
</div>

<!-- Botones de décadas para facilitar capturas para el PDF -->
<div class="text-center mb-4">
  <span style="font-size: 13px; margin-right:8px;">Ir rápido a:</span>
  <button class="btn btn-outline-secondary btn-decades" data-year="1985">1985</button>
  <button class="btn btn-outline-secondary btn-decades" data-year="1995">1995</button>
  <button class="btn btn-outline-secondary btn-decades" data-year="2005">2005</button>
  <button class="btn btn-outline-secondary btn-decades" data-year="2015">2015</button>
  <button class="btn btn-outline-secondary btn-decades" data-year="2025">2025</button>
</div>

<!-- Mapa -->
<div class="d-flex justify-content-between align-items-center mb-2">
  <h5>Mapa coroplético de temperatura máxima anual</h5>
  <button id="downloadMapBtn" class="btn btn-sm btn-outline-success">Descargar mapa como PNG</button>
</div>
<div id="map" class="mb-4"></div>

<!-- LEYENDA COMPLETA -->
<div class="legendContainer mb-5">
  <div class="legendBar"></div>
  <div id="legendTicks" class="legendTicks"></div>
  <div id="legendDataRange" class="mt-1 text-center" style="font-size: 12px; color:#555;"></div>
</div>

<!-- Heatmap -->
<div class="card shadow p-4 mb-5">
  <div class="d-flex justify-content-between align-items-center mb-2">
    <h4 class="mb-0">Mapa de Calor: Temperatura Máxima por Estado y Año</h4>
    <button id="downloadHeatmapBtn" class="btn btn-sm btn-outline-success">Descargar heatmap como PNG</button>
  </div>
  <p style="font-size:14px;">
    Cada fila es un estado y cada columna un año. El color representa la temperatura máxima anual promedio
    calculada a partir de los datos del archivo. Esta vista permite observar patrones de calentamiento a nivel estatal
    de forma muy clara.
  </p>
  <div id="heatmap"></div>
</div>

<script>
// =========================
// Archivos de datos
// =========================
const FILE_GEO  = "mexico_states.geojson";
const FILE_DATA = "data.csv";

// Normalización
const normalize = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

const fixName = {
  "mexico": "México",
  "estado de mexico": "México",
  "state of mexico": "México",
  "méxico": "México"
};

function unifyStateName(name) {
  const n = normalize(name);
  return fixName[n] || name.trim();
}

// Escala de temperatura global para leyenda y mapa
const LEGEND_MIN = 10;
const LEGEND_MAX = 35;

const colorScale = d3.scaleSequential(d3.interpolateRdYlBu)
                     .domain([LEGEND_MAX, LEGEND_MIN]); // rojo = más caliente

// Tooltip
const tooltip = d3.select("body").append("div")
  .attr("class", "tooltip")
  .style("opacity", 0);

// Utilidad para descargar SVG como PNG
function downloadSvgAsPng(svgElement, fileName) {
  const svgNode = svgElement.cloneNode(true);
  // quitar tooltips o cosas raras si hubiera; aquí no es necesario
  const serializer = new XMLSerializer();
  const svgString = serializer.serializeToString(svgNode);

  const blob = new Blob([svgString], {type: "image/svg+xml;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = function() {
    const rect = svgElement.getBoundingClientRect();
    const canvas = document.createElement("canvas");
    canvas.width = rect.width;
    canvas.height = rect.height;
    const ctx = canvas.getContext("2d");
    ctx.drawImage(img, 0, 0, rect.width, rect.height);
    URL.revokeObjectURL(url);

    const pngUrl = canvas.toDataURL("image/png");
    const a = document.createElement("a");
    a.href = pngUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  };
  img.src = url;
}

// =========================
// Cargar datos
// =========================
Promise.all([
  d3.json(FILE_GEO),
  d3.csv(FILE_DATA)
]).then(([geojson, data]) => {

  // -------------------------
  // 1. Preprocesamiento
  // -------------------------
  data.forEach(d => {
    d.STATE = unifyStateName(d.STATE);
    d.year  = +String(d.PERIOD).slice(0,4);
    d.max   = +d.MAX_C;
  });

  data = data.filter(d => !isNaN(d.year) && !isNaN(d.max));

  const years = Array.from(new Set(data.map(d => d.year))).sort((a,b)=>a-b);
  const states = Array.from(new Set(data.map(d => d.STATE))).sort();

  const minYear = years[0];
  const maxYear = years[years.length - 1];

  // Agrupado estado-año usando MAX_C
  const yearlyByState = d3.rollup(
    data,
    v => d3.mean(v, d => d.max),
    d => d.STATE,
    d => d.year
  );

  // Rango real observado
  let allMax = [];
  yearlyByState.forEach(m => m.forEach(v => allMax.push(v)));
  const dataExtent = d3.extent(allMax);

  d3.select("#legendDataRange").text(
    `Rango real observado (MAX_C): ${dataExtent[0].toFixed(1)}°C — ${dataExtent[1].toFixed(1)}°C`
  );

  // ============================
  // 2. MAPA COROPLÉTICO
  // ============================
  const mapWidth = 900, mapHeight = 600;
  const mapSvg = d3.select("#map")
    .append("svg")
    .attr("width", mapWidth)
    .attr("height", mapHeight);

  const projection = d3.geoMercator().fitSize([mapWidth, mapHeight], geojson);
  const path = d3.geoPath().projection(projection);

  function updateMap(year) {
    d3.select("#yearLabel").text("Año: " + year);

    mapSvg.selectAll("path").remove();

    mapSvg.selectAll("path")
      .data(geojson.features)
      .join("path")
      .attr("class", "state")
      .attr("d", path)
      .attr("fill", d => {
        const st = unifyStateName(d.properties.name);
        const map = yearlyByState.get(st);
        const val = map ? map.get(year) : null;
        if (!val) return "#ccc";
        return colorScale(val);
      })
      .on("mousemove", (e, d) => {
        const st = unifyStateName(d.properties.name);
        const map = yearlyByState.get(st);
        const val = map ? map.get(year) : null;

        tooltip.style("opacity", 1).html(`
          <strong>${st}</strong><br>
          Año: ${year}<br>
          Temp Máx: ${val ? val.toFixed(2) : "s/d"} °C
        `)
        .style("left", (e.pageX + 10) + "px")
        .style("top",  (e.pageY + 10) + "px");
      })
      .on("mouseout", () => tooltip.style("opacity", 0));
  }

  const slider = document.getElementById("yearSlider");
  slider.min = minYear;
  slider.max = maxYear;
  slider.value = minYear;

  slider.oninput = () => updateMap(+slider.value);

  document.getElementById("prevBtn").onclick = () => {
    slider.value = Math.max(+slider.value - 1, minYear);
    updateMap(+slider.value);
  };

  document.getElementById("nextBtn").onclick = () => {
    slider.value = Math.min(+slider.value + 1, maxYear);
    updateMap(+slider.value);
  };

  // Botones rápidos por década
  document.querySelectorAll(".btn-decades").forEach(btn => {
    btn.addEventListener("click", () => {
      const y = +btn.getAttribute("data-year");
      const yearToGo = Math.min(Math.max(y, minYear), maxYear);
      slider.value = yearToGo;
      updateMap(yearToGo);
    });
  });

  updateMap(minYear);

  // Botón para descargar mapa como PNG
  document.getElementById("downloadMapBtn").addEventListener("click", () => {
    const currentYear = +slider.value;
    downloadSvgAsPng(mapSvg.node(), `mapa_MAXC_${currentYear}.png`);
  });

  // ============================
  // 3. LEYENDA EXTENDIDA
  // ============================
  const ticks = d3.range(LEGEND_MIN, LEGEND_MAX + 0.1, 5);
  const legendDiv = d3.select("#legendTicks");
  legendDiv.html("");
  ticks.forEach(t => {
    legendDiv.append("span").text(t + "°C");
  });

  // ============================
  // 4. HEATMAP
  // ============================
  const heatWidth  = 900;
  const heatHeight = 650;

  const heatSvg = d3.select("#heatmap")
    .append("svg")
    .attr("width", heatWidth)
    .attr("height", heatHeight);

  const margin = {top: 40, right: 10, bottom: 40, left: 120};
  const iw = heatWidth  - margin.left - margin.right;
  const ih = heatHeight - margin.top  - margin.bottom;

  const g = heatSvg.append("g")
    .attr("transform", `translate(${margin.left},${margin.top})`);

  const x = d3.scaleBand().domain(years).range([0, iw]).padding(0.05);
  const y = d3.scaleBand().domain(states).range([0, ih]).padding(0.05);

  g.append("g").attr("transform", `translate(0,${ih})`)
    .call(
      d3.axisBottom(x)
        .tickValues(years.filter(yVal => yVal % 5 === 0))
        .tickFormat(d3.format("d"))
    )
    .selectAll("text")
      .attr("transform","rotate(-45)")
      .style("text-anchor","end")
      .style("font-size","10px");

  g.append("g")
    .call(d3.axisLeft(y))
    .selectAll("text")
      .style("font-size","11px");

  const cells = [];
  states.forEach(st => {
    const m = yearlyByState.get(st);
    years.forEach(year => {
      const val = m ? m.get(year) : null;
      cells.push({state: st, year, value: val});
    });
  });

  g.selectAll("rect")
    .data(cells)
    .join("rect")
      .attr("class","cell")
      .attr("x", d => x(d.year))
      .attr("y", d => y(d.state))
      .attr("width",  x.bandwidth())
      .attr("height", y.bandwidth())
      .attr("fill", d => d.value ? colorScale(d.value) : "#eee")
      .on("mousemove", (e,d) => {
        tooltip.style("opacity",1).html(`
          <strong>${d.state}</strong><br>
          Año: ${d.year}<br>
          Temp Máx: ${d.value ? d.value.toFixed(2) : "s/d"} °C
        `)
        .style("left",(e.pageX+10)+"px")
        .style("top",(e.pageY+10)+"px");
      })
      .on("mouseout",()=>tooltip.style("opacity",0));

  // Botón para descargar heatmap como PNG
  document.getElementById("downloadHeatmapBtn").addEventListener("click", () => {
    downloadSvgAsPng(heatSvg.node(), `heatmap_MAXC_${minYear}-${maxYear}.png`);
  });

}).catch(err => {
  alert("Error cargando archivos. Verifica data.csv y mexico_states.geojson y que el HTML se sirva por HTTP (Live Server).");
  console.error(err);
});
</script>

</body>
</html>
